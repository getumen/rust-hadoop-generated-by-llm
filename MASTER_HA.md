# Master High Availability (HA) ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Rust Hadoop DFSã®Masterã‚µãƒ¼ãƒãƒ¼ã®é«˜å¯ç”¨æ€§ï¼ˆHAï¼‰æ§‹æˆã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## æ¦‚è¦

Master HAã¯ã€ä»¥ä¸‹ã®ä»•çµ„ã¿ã§å®Ÿç¾ã•ã‚Œã¦ã„ã¾ã™ï¼š

- **Active-Standbyæ§‹æˆ**: 2ã¤ã®Masterãƒãƒ¼ãƒ‰ãŒèµ·å‹•ã—ã€1ã¤ãŒActiveã€ã‚‚ã†1ã¤ãŒStandbyã¨ã—ã¦å‹•ä½œ
- **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ãƒ™ãƒ¼ã‚¹ã®ãƒªãƒ¼ãƒ€ãƒ¼é¸å‡º**: å…±æœ‰ãƒœãƒªãƒ¥ãƒ¼ãƒ ä¸Šã®ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦Activeã‚’æ±ºå®š
- **æ°¸ç¶šåŒ–ã•ã‚ŒãŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**: ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§å…±æœ‰ãƒœãƒªãƒ¥ãƒ¼ãƒ ã«ä¿å­˜
- **è‡ªå‹•ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼**: Activeãƒãƒ¼ãƒ‰ãŒãƒ€ã‚¦ãƒ³ã™ã‚‹ã¨StandbyãŒè‡ªå‹•çš„ã«Activeã«æ˜‡æ ¼

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Shared Metadata Volume              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚master.lock â”‚  â”‚ metadata.json    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Master1    â”‚  â”‚  Master2     â”‚
    â”‚  (Active)   â”‚  â”‚  (Standby)   â”‚
    â”‚  :50051     â”‚  â”‚  :50051      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å®Ÿè£…ã®è©³ç´°

### 1. ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹ãƒªãƒ¼ãƒ€ãƒ¼é¸å‡º

å„Masterãƒãƒ¼ãƒ‰ã¯èµ·å‹•æ™‚ã«ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ï¼š

```rust
loop {
    match lock_file.try_lock_exclusive() {
        Ok(_) => {
            // ãƒ­ãƒƒã‚¯å–å¾—æˆåŠŸ â†’ Active Masterã¨ã—ã¦å‹•ä½œ
            println!("âœ“ Acquired master lock. Becoming ACTIVE master.");
            start_grpc_server().await?;
        }
        Err(_) => {
            // ãƒ­ãƒƒã‚¯å–å¾—å¤±æ•— â†’ Standbyã¨ã—ã¦å¾…æ©Ÿ
            println!("ğŸ”’ Master lock held by another process. Standing by...");
            tokio::time::sleep(Duration::from_secs(5)).await;
        }
    }
}
```

### 2. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–

ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼š

- ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆæ™‚ (`create_file`)
- ãƒ–ãƒ­ãƒƒã‚¯å‰²ã‚Šå½“ã¦æ™‚ (`allocate_block`)

```rust
fn save_state(&self) {
    let state = self.state.lock().unwrap();
    let data = serde_json::to_string_pretty(&*state).unwrap();
    fs::write(&self.metadata_path, data).unwrap();
}
```

### 3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼

ChunkServerã¨CLIã¯è¤‡æ•°ã®Masterã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§æŒ‡å®šã§ãã¾ã™ï¼š

```bash
--master-addr dfs-master1:50051,dfs-master2:50051
```

æ¥ç¶šæ™‚ã«é †ç•ªã«è©¦è¡Œã—ã€æœ€åˆã«æˆåŠŸã—ãŸMasterã«æ¥ç¶šã—ã¾ã™ã€‚

## Docker Composeæ§‹æˆ

### Masterè¨­å®š

```yaml
master1:
  command: /app/master --addr 0.0.0.0:50051 --metadata-dir /var/lib/dfs/metadata
  volumes:
    - metadata-volume:/var/lib/dfs/metadata

master2:
  command: /app/master --addr 0.0.0.0:50051 --metadata-dir /var/lib/dfs/metadata
  volumes:
    - metadata-volume:/var/lib/dfs/metadata
```

ä¸¡æ–¹ã®MasterãŒåŒã˜`metadata-volume`ã‚’å…±æœ‰ã—ã¾ã™ã€‚

### ChunkServerè¨­å®š

```yaml
chunkserver1:
  command: /app/chunkserver --addr 0.0.0.0:50052 \
    --master-addr dfs-master1:50051,dfs-master2:50051 \
    --storage-dir /data/cs1 \
    --advertise-addr dfs-chunkserver1:50052
  depends_on:
    - master1
    - master2
```

## ä½¿ç”¨æ–¹æ³•

### ã‚¯ãƒ©ã‚¹ã‚¿ã®èµ·å‹•

```bash
./start_cluster.sh
```

èµ·å‹•å¾Œã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
Master1:
  Master node starting...
  âœ“ Acquired master lock. Becoming ACTIVE master.
  Master listening on 0.0.0.0:50051

Master2:
  Master node starting...
  ğŸ”’ Master lock held by another process. Standing by...
```

### ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ

è¤‡æ•°ã®Masterã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®šã—ã¦CLIã‚’å®Ÿè¡Œï¼š

```bash
docker run --rm --network rust-hadoop_dfs-network \
  -v $(pwd)/test.txt:/tmp/test.txt \
  rust-hadoop-master1 \
  /app/dfs_cli --master http://dfs-master1:50051,http://dfs-master2:50051 \
  put /tmp/test.txt /test.txt
```

### ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã®ãƒ†ã‚¹ãƒˆ

#### 1. Active Masterã‚’åœæ­¢

```bash
docker-compose stop master1
```

#### 2. Standbyã®æ˜‡æ ¼ã‚’ç¢ºèª

Master2ã®ãƒ­ã‚°ã‚’ç¢ºèªï¼š

```bash
docker-compose logs -f master2
```

æ•°ç§’å¾Œã€ä»¥ä¸‹ã®ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
âœ“ Acquired master lock. Becoming ACTIVE master.
Loading metadata from "/var/lib/dfs/metadata/metadata.json"
Master listening on 0.0.0.0:50051
```

#### 3. ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãŒç¶™ç¶šã§ãã‚‹ã“ã¨ã‚’ç¢ºèª

```bash
docker run --rm --network rust-hadoop_dfs-network \
  rust-hadoop-master1 \
  /app/dfs_cli --master http://dfs-master1:50051,http://dfs-master2:50051 ls
```

Master1ã¸ã®æ¥ç¶šãŒå¤±æ•—ã—ã¦ã‚‚ã€è‡ªå‹•çš„ã«Master2ã«æ¥ç¶šã•ã‚Œã¾ã™ã€‚

#### 4. Master1ã‚’å†èµ·å‹•

```bash
docker-compose start master1
```

Master1ã¯Standbyã¨ã—ã¦èµ·å‹•ã—ã¾ã™ã€‚

## ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã®ã‚·ãƒŠãƒªã‚ª

### ã‚·ãƒŠãƒªã‚ª1: Active Masterã®ã‚¯ãƒ©ãƒƒã‚·ãƒ¥

1. **ç™ºç”Ÿ**: Master1ï¼ˆActiveï¼‰ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥
2. **æ¤œå‡º**: Master2ãŒ5ç§’ã”ã¨ã«ãƒ­ãƒƒã‚¯å–å¾—ã‚’è©¦è¡Œ
3. **æ˜‡æ ¼**: Master2ãŒãƒ­ãƒƒã‚¯ã‚’å–å¾—ã—ã€Activeã«æ˜‡æ ¼
4. **å¾©æ—§**: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‹ã‚‰èª­ã¿è¾¼ã¿
5. **ã‚µãƒ¼ãƒ“ã‚¹ç¶™ç¶š**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è‡ªå‹•çš„ã«Master2ã«æ¥ç¶š

**ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ **: æœ€å¤§5ç§’ï¼ˆãƒ­ãƒƒã‚¯å†è©¦è¡Œé–“éš”ï¼‰

### ã‚·ãƒŠãƒªã‚ª2: Active Masterã®è¨ˆç”»çš„åœæ­¢

1. **åœæ­¢**: `docker-compose stop master1`
2. **æ˜‡æ ¼**: Master2ãŒå³åº§ã«ãƒ­ãƒƒã‚¯ã‚’å–å¾—
3. **ã‚µãƒ¼ãƒ“ã‚¹ç¶™ç¶š**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è‡ªå‹•çš„ã«Master2ã«æ¥ç¶š

**ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ **: ã»ã¼ã‚¼ãƒ­

### ã‚·ãƒŠãƒªã‚ª3: ä¸¡æ–¹ã®MasterãŒãƒ€ã‚¦ãƒ³

1. **ç™ºç”Ÿ**: Master1ã¨Master2ãŒä¸¡æ–¹ãƒ€ã‚¦ãƒ³
2. **å½±éŸ¿**: æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ»ãƒ–ãƒ­ãƒƒã‚¯å‰²ã‚Šå½“ã¦ãŒä¸å¯
3. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿**: ChunkServerã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯èª­ã¿å–ã‚Šå¯èƒ½ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ï¼‰
4. **å¾©æ—§**: ã„ãšã‚Œã‹ã®Masterã‚’å†èµ·å‹•ã™ã‚‹ã¨ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã‚µãƒ¼ãƒ“ã‚¹å†é–‹

## ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§

### ä¿è¨¼ã•ã‚Œã‚‹æ•´åˆæ€§

- âœ… ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ»ãƒ–ãƒ­ãƒƒã‚¯å‰²ã‚Šå½“ã¦ã¯å³åº§ã«ãƒ‡ã‚£ã‚¹ã‚¯ã«æ°¸ç¶šåŒ–
- âœ… Activeã®åˆ‡ã‚Šæ›¿ãˆæ™‚ã€æ–°ã—ã„Activeã¯æœ€æ–°ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
- âœ… ChunkServerã®ç™»éŒ²æƒ…å ±ã¯æ®ç™ºæ€§ï¼ˆå†èµ·å‹•æ™‚ã«å†ç™»éŒ²ï¼‰

### åˆ¶é™äº‹é …

- âš ï¸ åŒæ™‚ã«è¤‡æ•°ã®ActiveãŒå­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ï¼ˆSplit-brainï¼‰ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ã§é˜²æ­¢
- âš ï¸ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿ä¸­ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨ã€éƒ¨åˆ†çš„ãªæ›´æ–°ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§
  - æ”¹å–„ç­–: Write-Ahead Logã‚„ã‚¢ãƒˆãƒŸãƒƒã‚¯ãªæ›¸ãè¾¼ã¿ã®å®Ÿè£…

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ä¸¡æ–¹ã®MasterãŒStandbyã®ã¾ã¾

**åŸå› **: ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ®‹ã£ã¦ã„ã‚‹

**è§£æ±ºç­–**:
```bash
docker-compose down -v
docker-compose up -d
```

### ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ãªã„

**åŸå› **: metadata.jsonãŒç ´æ

**è§£æ±ºç­–**:
```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Œã°å¾©å…ƒ
docker-compose down
# å…±æœ‰ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
docker volume rm rust-hadoop_metadata-volume
docker-compose up -d
```

### ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãŒé…ã„

**åŸå› **: ãƒ­ãƒƒã‚¯å†è©¦è¡Œé–“éš”ãŒé•·ã„

**è§£æ±ºç­–**: `src/bin/master.rs`ã®`Duration::from_secs(5)`ã‚’çŸ­ãã™ã‚‹

## ä»Šå¾Œã®æ”¹å–„æ¡ˆ

1. **Raft/Paxosãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹**: ã‚ˆã‚Šå …ç‰¢ãªãƒªãƒ¼ãƒ€ãƒ¼é¸å‡º
2. **Write-Ahead Log (WAL)**: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®åŸå­æ€§ä¿è¨¼
3. **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**: è¤‡æ•°ãƒãƒ¼ãƒ‰ã§ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å†—é•·åŒ–
4. **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼**: ã‚ˆã‚Šé«˜é€Ÿãªéšœå®³æ¤œå‡º
5. **è‡ªå‹•ãƒªãƒãƒ©ãƒ³ã‚¹**: Masterå¾©å¸°æ™‚ã®è² è·åˆ†æ•£

## ã¾ã¨ã‚

ã“ã®HAå®Ÿè£…ã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒå®Ÿç¾ã•ã‚Œã¦ã„ã¾ã™ï¼š

- âœ… **é«˜å¯ç”¨æ€§**: Single Point of Failureã®æ’é™¤
- âœ… **ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šæ€§**: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–
- âœ… **è‡ªå‹•ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼**: æ‰‹å‹•ä»‹å…¥ä¸è¦
- âœ… **ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…**: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ãƒ™ãƒ¼ã‚¹ã®è»½é‡ãªä»•çµ„ã¿

æœ¬ç•ªç’°å¢ƒã§ã¯ã€ã‚ˆã‚Šé«˜åº¦ãªã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ¡ç”¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
