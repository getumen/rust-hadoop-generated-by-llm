syntax = "proto3";

package dfs;

service MasterService {
  // File system operations
  rpc GetFileInfo (GetFileInfoRequest) returns (GetFileInfoResponse);
  rpc CreateFile (CreateFileRequest) returns (CreateFileResponse);
  rpc AllocateBlock (AllocateBlockRequest) returns (AllocateBlockResponse);
  rpc CompleteFile (CompleteFileRequest) returns (CompleteFileResponse);
  rpc ListFiles (ListFilesRequest) returns (ListFilesResponse);
  rpc DeleteFile (DeleteFileRequest) returns (DeleteFileResponse);


  // Rename operation (supports cross-shard rename via Transaction Record)
  rpc Rename (RenameRequest) returns (RenameResponse);

  // Cross-shard transaction support
  rpc PrepareTransaction (PrepareTransactionRequest) returns (PrepareTransactionResponse);
  rpc CommitTransaction (CommitTransactionRequest) returns (CommitTransactionResponse);
  rpc AbortTransaction (AbortTransactionRequest) returns (AbortTransactionResponse);

  // DataNode registration (simplified)
  rpc RegisterChunkServer (RegisterChunkServerRequest) returns (RegisterChunkServerResponse);

  // Block recovery
  rpc GetBlockLocations (GetBlockLocationsRequest) returns (GetBlockLocationsResponse);

  // Liveness check
  rpc Heartbeat (HeartbeatRequest) returns (HeartbeatResponse);

  // Safe Mode operations
  rpc GetSafeModeStatus (GetSafeModeStatusRequest) returns (GetSafeModeStatusResponse);
  rpc SetSafeMode (SetSafeModeRequest) returns (SetSafeModeResponse);

  // Raft cluster membership management
  rpc AddRaftServer (AddRaftServerRequest) returns (AddRaftServerResponse);
  rpc RemoveRaftServer (RemoveRaftServerRequest) returns (RemoveRaftServerResponse);
  rpc GetClusterInfo (GetClusterInfoRequest) returns (GetClusterInfoResponse);

  // Metadata ingestion for shard splitting
  rpc IngestMetadata (IngestMetadataRequest) returns (IngestMetadataResponse);

  // Trigger background data shuffling
  rpc InitiateShuffle (InitiateShuffleRequest) returns (InitiateShuffleResponse);
}

message HeartbeatRequest {
  string chunk_server_address = 1;
  uint64 used_space = 2;
  uint64 available_space = 3;
  uint64 chunk_count = 4;
}

message HeartbeatResponse {
  bool success = 1;
  repeated ChunkServerCommand commands = 2;
}

message ChunkServerCommand {
  enum CommandType {
    UNKNOWN = 0;
    REPLICATE = 1;
    DELETE = 2; // Future use
  }
  CommandType type = 1;
  string block_id = 2;
  string target_chunk_server_address = 3; // For REPLICATE
}

service ChunkServerService {
  rpc WriteBlock (WriteBlockRequest) returns (WriteBlockResponse);
  rpc ReadBlock (ReadBlockRequest) returns (ReadBlockResponse);
  rpc ReplicateBlock (ReplicateBlockRequest) returns (ReplicateBlockResponse);
}

// Messages

message GetFileInfoRequest {
  string path = 1;
}

message GetFileInfoResponse {
  FileMetadata metadata = 1;
  bool found = 2;
}

message CreateFileRequest {
  string path = 1;
}

message CreateFileResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3; // Optional hint about current leader address
}

message AllocateBlockRequest {
  string path = 1;
}

message AllocateBlockResponse {
  BlockInfo block = 1;
  repeated string chunk_server_addresses = 2;
  string leader_hint = 3; // Optional hint about current leader address
}

message CompleteFileRequest {
  string path = 1;
  uint64 size = 2;
}

message CompleteFileResponse {
  bool success = 1;
}

message ListFilesRequest {
  string path = 1;
}

message ListFilesResponse {
  repeated string files = 1;
}

message DeleteFileRequest {
  string path = 1;
}

message DeleteFileResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;
}


message RegisterChunkServerRequest {
  string address = 1;
  uint64 capacity = 2;
}

message RegisterChunkServerResponse {
  bool success = 1;
}

message WriteBlockRequest {
  string block_id = 1;
  bytes data = 2;
  repeated string next_servers = 3; // For replication pipeline
}

message WriteBlockResponse {
  bool success = 1;
  string error_message = 2;
}

message ReadBlockRequest {
  string block_id = 1;
}

message ReadBlockResponse {
  bytes data = 1;
}

message FileMetadata {
  string path = 1;
  uint64 size = 2;
  repeated BlockInfo blocks = 3;
}

message BlockInfo {
  string block_id = 1;
  uint64 size = 2;
  repeated string locations = 3;
}

message ReplicateBlockRequest {
  string block_id = 1;
  bytes data = 2;
  repeated string next_servers = 3; // Remaining servers in the pipeline
}

message ReplicateBlockResponse {
  bool success = 1;
  string error_message = 2;
}

message GetBlockLocationsRequest {
  string block_id = 1;
}

message GetBlockLocationsResponse {
  repeated string locations = 1;
  bool found = 2;
}

service ConfigService {
  rpc FetchShardMap (FetchShardMapRequest) returns (FetchShardMapResponse);
  rpc AddShard (AddShardRequest) returns (AddShardResponse);
  rpc RemoveShard (RemoveShardRequest) returns (RemoveShardResponse);
  rpc SplitShard (SplitShardRequest) returns (SplitShardResponse);

  // Master node management
  rpc RegisterMaster (RegisterMasterRequest) returns (RegisterMasterResponse);
  rpc ShardHeartbeat (ShardHeartbeatRequest) returns (ShardHeartbeatResponse);
}

message FetchShardMapRequest {}

message ShardPeers {
  repeated string peers = 1;
}

message FetchShardMapResponse {
  map<string, ShardPeers> shards = 1;
}

message AddShardRequest {
  string shard_id = 1;
  repeated string peers = 2;
}

message AddShardResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;
}

message RemoveShardRequest {
  string shard_id = 1;
}

message RemoveShardResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;
}

message SplitShardRequest {
  string shard_id = 1;
  string split_key = 2;
  string new_shard_id = 3;
  repeated string new_shard_peers = 4;
}

message SplitShardResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;
  repeated string new_shard_peers = 4;
}

// ============================================================================
// Rename Operation Messages
// ============================================================================

message RenameRequest {
  string source_path = 1;     // Source file path
  string dest_path = 2;       // Destination file path
}

message RenameResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;     // Hint for correct leader (if not leader)
  string redirect_hint = 4;   // Hint for correct shard (if wrong shard)
}

// ============================================================================
// Cross-Shard Transaction Messages
// ============================================================================

message PrepareTransactionRequest {
  string tx_id = 1;                   // Transaction ID (UUID)
  string operation_type = 2;          // "CREATE" or "DELETE"
  string path = 3;                    // Target file path
  FileMetadata metadata = 4;          // For CREATE operation: file metadata
  string coordinator_shard = 5;       // Coordinator shard ID (for callback)
  repeated string coordinator_peers = 6;  // Coordinator shard peers
}

message PrepareTransactionResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;
}

message CommitTransactionRequest {
  string tx_id = 1;                   // Transaction ID
}

message CommitTransactionResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;
}

message AbortTransactionRequest {
  string tx_id = 1;                   // Transaction ID
}

message AbortTransactionResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;
}

// ============================================================================
// Safe Mode Messages
// ============================================================================

message GetSafeModeStatusRequest {}

message GetSafeModeStatusResponse {
  bool is_safe_mode = 1;            // Whether cluster is in safe mode
  bool is_manual = 2;               // Whether safe mode was manually triggered
  uint32 chunk_server_count = 3;    // Number of registered ChunkServers
  uint32 expected_blocks = 4;       // Expected number of blocks
  uint32 reported_blocks = 5;       // Number of reported blocks
  double threshold = 6;             // Safe mode exit threshold (0.0-1.0)
  uint64 entered_at = 7;            // Timestamp when safe mode was entered
}

message SetSafeModeRequest {
  bool enter = 1;                   // true = enter safe mode, false = leave safe mode
}

message SetSafeModeResponse {
  bool success = 1;
  string error_message = 2;
  bool is_safe_mode = 3;            // Current safe mode status after operation
}

// ============================================================================
// Raft Cluster Membership Management Messages
// ============================================================================

message AddRaftServerRequest {
  uint32 server_id = 1;             // Server ID to add
  string server_address = 2;        // Server's HTTP address for Raft RPC
}

message AddRaftServerResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;           // Hint if not the leader
}

message RemoveRaftServerRequest {
  uint32 server_id = 1;             // Server ID to remove
}

message RemoveRaftServerResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;           // Hint if not the leader
}

message GetClusterInfoRequest {}

message GetClusterInfoResponse {
  uint32 node_id = 1;               // This node's ID
  string role = 2;                  // Current role (Leader, Follower, Candidate)
  uint64 current_term = 3;          // Current Raft term
  uint32 leader_id = 4;             // Current leader's ID (0 if unknown)
  string leader_address = 5;        // Current leader's address
  repeated ClusterMember members = 6;  // All cluster members
  uint64 commit_index = 7;          // Current commit index
  uint64 last_applied = 8;          // Last applied index
}

message ClusterMember {
  uint32 server_id = 1;             // Server ID (index in peers list)
  string address = 2;               // Server's HTTP address
  bool is_self = 3;                 // True if this is the current node
}

// ============================================================================
// Shard Phase 2 Messages
// ============================================================================

message IngestMetadataRequest {
  repeated FileMetadata files = 1;
}

message IngestMetadataResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;
}

message RegisterMasterRequest {
  string address = 1;               // Master HTTP address
  string shard_id = 2;              // Shard this master belongs to
}

message RegisterMasterResponse {
  bool success = 1;
}

message ShardHeartbeatRequest {
  string address = 1;               // Master HTTP address
  map<string, double> rps_per_prefix = 2; // Current load info for balancing
}

message ShardHeartbeatResponse {
  bool success = 1;
}

message InitiateShuffleRequest {
  string prefix = 1;
}

message InitiateShuffleResponse {
  bool success = 1;
  string error_message = 2;
  string leader_hint = 3;
}
